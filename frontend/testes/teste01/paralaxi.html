<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
        * {
            box-sizing: border-box;
            padding: 0;
            margin: 0;
        }

        body {
            width: 100%;
            height: 200vh;
        }

        .game {
            background-color: rgb(43, 43, 43);
            height: 100%;
            width: 100%;
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .game-section {
            width: 100%;
            background-color: blueviolet;
            padding: 20px;
            margin-bottom: 20px;
        }

        .game-section-parallax {
            position: relative;
            width: 80%;
            aspect-ratio: 4 / 3;
            margin: auto;
        }

        .game-section-parallax img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Classe adicional para quando o elemento estiver próximo do topo */
        .game-section-parallax.near-top {
            border: 3px solid gold;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.7);
        }

        .game-section-parallax img {
            transition: transform 0.05s linear;
        }

        .game-section-parallax {
            overflow: hidden;
        }
    </style>
</head>

<body>
    <div style="height: 500px;"></div>
    <div class="game"></div>
    <script>
        document.addEventListener("DOMContentLoaded", async () => {
            try {
                const response = await fetch("http://localhost:8080/api/game/11");
                if (!response.ok) throw new Error("Erro ao buscar os dados do jogo.");
                const data = await response.json();

                const gameContainer = document.querySelector(".game");
                gameContainer.innerHTML = "";

                data.sections.forEach(section => {
                    const sectionDiv = document.createElement("div");
                    sectionDiv.classList.add("game-section");

                    const title = document.createElement("h2");
                    title.textContent = section.title;

                    const paragraph = document.createElement("p");
                    paragraph.textContent = section.text;

                    const parallaxDiv = document.createElement("div");
                    parallaxDiv.classList.add("game-section-parallax");

                    section.parallaxLayers.forEach(layer => {
                        const img = document.createElement("img");
                        const isFullUrl = layer.image.startsWith("http");
                        img.src = isFullUrl ? layer.image : `http://localhost:8080/images/${layer.image}`;
                        img.alt = `Camada ${layer.id}`;
                        img.dataset.speed = layer.speed;
                        parallaxDiv.appendChild(img);
                    });

                    sectionDiv.appendChild(title);
                    sectionDiv.appendChild(paragraph);
                    sectionDiv.appendChild(parallaxDiv);
                    gameContainer.appendChild(sectionDiv);
                });

                // ===== ADICIONA A VERIFICAÇÃO DE SCROLL AQUI =====
                function handleScroll() {
                    const parallaxElements = document.querySelectorAll('.game-section-parallax');
                    const viewportCenter = window.innerHeight / 2;

                    parallaxElements.forEach(parallax => {
                        const rect = parallax.getBoundingClientRect();
                        const elementCenter = rect.top + rect.height / 2;
                        const distanceToCenter = elementCenter - viewportCenter;

                        const layers = parallax.querySelectorAll('img');
                        layers.forEach(layer => {
                            const speed = parseFloat(layer.dataset.speed) || 0;

                            // Parar o parallax se a distância do centro estiver dentro de ±100px
                            if (distanceToCenter < 0) {
                                layer.style.transform = `translateY(0px)`;
                            } else {
                                const offset = distanceToCenter * (speed / 10);
                                layer.style.transform = `translateY(${offset}px)`;
                            }
                        });
                    });
                }


                // Adiciona o evento de scroll com throttle para performance
                function throttle(func, limit) {
                    let inThrottle;
                    return function () {
                        const args = arguments;
                        const context = this;
                        if (!inThrottle) {
                            func.apply(context, args);
                            inThrottle = true;
                            setTimeout(() => inThrottle = false, limit);
                        }
                    };
                }

                window.addEventListener('scroll', throttle(handleScroll, 100));
                handleScroll(); // Executa uma vez no carregamento

            } catch (error) {
                console.error("Erro ao carregar dados do jogo:", error);
            }
        });
    </script>
</body>

</html>